---
layout:     post
title:      "ARM裸机-中断基本概念"
subtitle:   "ARM Tiny210 Interrupt"
date:       2017-02-27 19:00:00
author:     "陈登龙"
header-img: "img/post-bg-unix-linux.jpg"
catalog: true
tags:
    - ARM裸机
---


# 中断基本概念

**一，中断简介**

中断是针对硬件的一种方式，CPU的PC本来是顺序执行的，中断相当于打断PC运行的轨迹，将PC指向一个处理代码块，等待处理结束，再回到被打断的PC指针指向的位置。
模型如下：
![INT][1]



**二，异常与中断**

异常：发生突发事件，是一种特殊的软中断，以CPU为中心。
中断：中途打断，以外设为核心。
例如：按键按下，属于中断，而应用程序抛出的异常属于CPU异常。
异常和中断有很强的相关性，中断是一种特殊的异常。



**三，ARM的七种工作模式**

来自官网的介绍：
![ARM CPU Mode][2]

ARM一共有**7种工作模式**，不同工作模式的区别如下：
**1.不同的寄存器**：一种模式下的专用寄存器在切换到其他工作模式时，不用保存和恢复
**2.不同的权限**：管理模式的权限高于用户模式
**3.触发条件**：例如，上电后，处于SVC模式，中断发生后处于IRQ。

ARM体系结构中有7种异常处理，异常发生时，处理器会把**PC指向一个特殊地址**，这个地址放在存储器中一个特定表中，成为**向量表**。

**CPU如何处理异常呢？**

1.保存当前PC执行位置

2.保存当前执行状态

3.寻找中断入口，即向量表地址

4.执行中断服务例程，ISR

5.中断返回，继续执行

例如复位异常Reset：
当处理器的复位引脚有效时，系统产生复位异常，复位异常通常用于系统上电和复位。

中断的处理与异常的处理基本相同。


**四，中断控制器**

把多个中断源通过选择或者优先级比较，给CPU核心触发对应信号的一个工作，哪个中断源发生了请求，就根据这个请求，做不同的事情。

类似于switch(xx)语句，switch语句有2种实现：

**1.查询中断控制器**：在中断控制器中用一个寄存器来保存中断号，在处理程序中，读取中断号，然后switch(中断号)来做相应的工作。
缺点：在中断源比较多的情况下，switch的效率不高。

**2.向量中断控制器**：用硬件去实现软件查找和软件中断向量表的功能。
优点：硬件实现的速度快。

我们一般通过配置中断控制器来控制外设产生中断。
**SOC有一个主中断控制器**，**每个外设也有一个自己的中断控制器**，他们的关系如下：
![INTCtl][3]
可以看出：**每个中断源有一个独立的中断控制器，所有的中断源由一个主中断控制器来控制。**

中断控制器对于**裸机开发比较重要**，而对于**带有OS的开发则不是太重要**，因为OS已经帮我们控制了中断控制器。

**五，中断向量表**

中断向量表是存储中断向量地址的表格，即**中断处理函数的入口地址**。
![VectTable][4]
其中存储了串口，ADC，Key这3个中断处理程序的地址。例如，当Key被按下时，Key_handle函数就会自动被调用。


  [1]: https://cheng-zhi.github.io/img/post-2017-02-27-INT.png
  [2]: https://cheng-zhi.github.io/img/post-2017-02-27-ARM-CPU-Mode.png
  [3]: https://cheng-zhi.github.io/img/post-2017-02-27-INT-Ctl.png
  [4]: https://cheng-zhi.github.io/img/post-2017-02-27-VectTable.png