---
title: Linux 高级编程 - IO 概述 
date : 2017-07-26 15:00:00
---

# Linux 高级编程 - IO 概述
***
> 版权声明：本文为 {{ site.name }} 原创文章，可以随意转载，但必须在明确位置注明出处！ 

## IO 概述
这篇文章主要**介绍 Linux IO 的基本知识和学习方法**，掌握这些再学习 IO 操作会更加游刃有余，更加系统。


## 上层开发与 kenel 的关系
在学习 Linux 的 IO 操作之前，我们先来了解下上层开发和 kernel 底层的关系，也就是说上层大体上是如何调用底层的。我们以在 Linux 上开发的 C 程序为例简单介绍一下，因为这部分详细介绍很复杂，而我们开发上层只需要了解基本的过程即可，对底层有兴趣可以深入研究。

### 自顶向下
我们从上到下来看看一个 C 的 IO 程序是如何调用内核方法的：
```
Linux C App -> glibc（C 库）-> VFS（虚拟文件系统）-> kernel function（内核方法）
```

这只是以 C 程序为例，Linux 的 C 程序现在使用的是 `GNU C Libary, glibc`，但是 Linux 也支持不同的语言，通过类比可以知道，每种语言也应该都提供了相应的类库。

更加简单的理解可以说成：**操作系统内核提供功能的实现，上层类库将这些实现封装成 API 库供上层调用，如果某个库需要跨平台，那么这个库的接口就需要符合一定的规则**。

例如**标准 C 库 `ANSI C` 就是跨平台的**，它的接口标准由**国际标准化组织**（ISO）制定，你在 Linux 上用 `ANSI C` 写的 C 程序在 Windows 上也能运行，因为 Windows 也支持 `ANSI C` 。


## Linux IO 体系结构
在学习 IO 操作之前，我们也需要对 Linux 的 IO 系统有一个大致的了解，总体来说，Linux 的上层 IO 结构有下面 3 个方面：
1. 文件系统 API：Linux 下有很多种文件系统，但是为了统一接口，Linux 提供了 VFS，我们需要学会使用 VFS 的 API
2. 驱动和总线：提供对硬件的操作接口，需要了解
3. 设备类型：键盘，鼠标等硬件 IO 设备，需要了解

Linux 下所有的设备都是文件，所以都可以使用文件系统的 API 来操作，一个基本的方式如下：
```
LinuxApp (open...) -> /dev/xxx -> VFS -> xFS -> 总线 -> 驱动 -> 硬件
```

这其中 VFS 提供的对多种不同的 FS 的统一接口非常重要，这使得上层 APP 只需调用统一的 API，而不用担心当前使用的是哪种文件系统：

![VFS]({{ site.url }}/images/vfs.png)

> VFS（虚拟文件系统） 是抽象在计算机中的典型应用


## 通用的 IO 操作
IO 操作即使是在不同的系统上也经常提供下面这些功能（不是全部）：
1. 打开，关闭文件：open，close
2. 读，写文件：read，write
3. 控制文件：seek 移动文件指针等

这些基本上可以说是一个 IO 系统最基本的操作，其中打开，关闭，读写都是平常的必备操作。那么 Linux 的 IO 操作有没有什么特别的地方呢？

## Linux 的 IO 操作分类
Linux 的 IO 操作大致可以分为以下几类：
1. 标准 IO：使用 ANSI C 提供的 API
2. 底层 IO：使用 Posix C 提供的 API
3. FS 文件系统接口：掌握访问 FS 的 API
4. 管道及 FIFO（先入先出队列）：用于进程间通信
5. Socket：比较特殊的 IO 操作，用于网络访问
6. 底层终端接口（tty）：字符终端也是一种 IO

在 IO 阶段主要还是以**标准和底层 IO 为主**，其他的类别一般都在进程，网络中介绍。

## Linux IO 数据结构
开发上层 Linux IO 类型的程序，你首先需要理解下面这 3 个数据结构，它们非常重要，是一切操作的核心。
### 1. 文件描述符 FD
对于 Linux 内核来说，**一个打开的文件是一个文件描述符（File Description，FD）**的引用，FD 是一个非负整数。当打开一个现存的文件或者创建一个新文件时，内核向进程返回一个文件描述符，当读写文件时，用 open 或 read 返回的文件描述符 fd 标识该文件，将其作为参数传送给 read 和 write 。

每个进程都有默认的 `FD[0, 1, 2]`：
1. `STDIN_FILENO`：标准输入，FD = 0
2. `STDOUT_FILENO`：标准输出，FD = 1
3. `STDERR_FILENO`：标准错误输出，FD = 2

### 2. File 结构
**`struct file` 在内核中其实就代表了一个实际的文件**，我们需要了解其中比较重要的字段：
```c
struct file {
	// 文件链表指针
	struct list_head f_list;
	
	// 文件对应目录结构
	struct dentry *f_dentry;
	
	// 虚拟文件系统挂载点
	struct vfsmount *f_vfsmnt;
	
	// 文件操作函数指针
	struct file_operations *f_op;

	...

	// 文件模式
	mode_t f_mode;

	// 文件 offset
	loff_t f_pos;
};
```



### 3. Files Structure
`file_struct` **保存了一个进程打开的所有文件表的数据**：
```c
struct file_struct {
	// 自动曾量
	atomic_t count;
	
	...
	
	// 最大文件句柄数目
	int max_fds;

	// 最大的 fd 集合容量
	int max_fdset;

	// 下一个空闲的 fs
	int next_fd;
	...
};
```

## 如何学习 IO 操作？
给你 2 个最好的免费资源：
1. [glibc 官网](https://www.gnu.org/software/libc)
2. Linux 自带的 man 手册，例如：`man 2 open`

最好的方法是看 GNU 的官方文档和系统自带的 man 手册，我们已经知道 Linux C 使用的是 glibc 库，那么我们可以去 GNU 官网去查找这个库，发现它是开源的并且提供了非常好的学习文档，而 man 是 Linux 系统自带的，用起来也非常简单，例如 `man 2 open` 即可查看 open 函数的用法，介绍非常详细。但是市面上的那些培训机构却只会教你如何使用 API，而不教你如何查找这些 API 的学习资料，实在有些可惜。

> 一个函数名可能对应一个 shell 命令，当你用 `man open` 发现没找到函数定义时，试试 `man 2 open` 或者 `man [n] open`

如果你养成学习一种技术，首先到它的官网去查找学习资料的好习惯，那么你的进步会非常的快，相信我。因为没有比官网的资料更权威的了，那些写博客的也只不过是翻译并加上一些自己的理解，说实话当你自己看懂了那些英文文档，你就不需要看任何博客了，因为你已经找到了最好的「博客」。

如果你喜欢看英文那么你完全可以不看我之后更新的 IO 的内容，因为我的内容也是根据官网的文档自己总结的，你英文能力强，完全可以看原汁原味的资料，我更加**希望你能不依赖别人而学习，一个人的进步 90 % 要靠自己**，何况我自己的理解可能也不太准确呢。但是如果你的**英文不太好，那么我建议你可以对照我的博客和官方文档来看**，慢慢养成看英文的好习惯，受益终生。



## 结语
概述讲的太多就没有意义了，这篇文章主要让你对 IO 有一个基本的了解，**最重要的是你要理解上层 APP 大体的执行过程**和**如何系统的学习 IO 操作，养成看英文文档的习惯**，这才是这篇文章介绍的最重要的内容，具体的 IO 操作的文章后面会有更新，敬请期待。

最后，感谢你的阅读，我们下次再见 :)
