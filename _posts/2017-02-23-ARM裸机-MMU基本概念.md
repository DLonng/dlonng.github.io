---
layout:     post
title:      "ARM裸机-MMU基本概念"
subtitle:   "ARM MMU"
date:       2017-02-23 14:00:00
author:     "陈登龙"
header-img: "img/post-bg-unix-linux.jpg"
catalog: true
tags:
    - ARM裸机
---
 


# ARM裸机-MMU基本概念
 
 **一，MMU简介**
 
 **Memory Management Unit(MMU) 称为内存管理单元**。
 
 从定义可以看出，MMU是用来管理内存的，那么是管理哪种内存呢？在Linux中，MMU负责管理虚拟地址到物理地址的转换过程。
 
 MMU主要有下面**2个作用**：

 1.允许多个进程之间有效而安全的共享存储器，表现为MMU的**权限管理**职能。

 2.消除一个小而受限的主存容量对程序设计的影响，表现为MMU的**地址映射**职能。
 
 
 下面是一个SOC中，MMU的模型图：
 ![MMU][1]
 

当启用MMU时，CPU发出的虚拟地址经过MMU的转换后生成物理地址，然后交给存储管理器去寻址。
如果没有启动MMU，则CPU直接发送物理地址给存储管理器进行寻址。
 
 
 **二，MMU的2个职能**
 
**1.权限管理** 

现在CPU都支持多道程序运行，但是在同一时刻，仍然只有一个进程在运行。由于有多个进程在内存中，所以就需要一种管理机制，不能让一个进程访问另一个进程的数据。
MMU就具有这种功能，它可以使得：**一个用户进程不能访问其他用户进程空间以及内核空间**，在Linux中，用户进程要通过系统调用才能陷入内核中。
 
**2.地址映射**

在32Bit的Linux中，**每个进程**都有一个**独立**的4G**虚拟地址空间**，进程最终访问的是物理地址，也就需要将虚拟地址转换成物理地址，如何转换呢？**MMU使用地址映射**，就是构建一个**虚拟地址到物理地址的映射表**，根据虚拟地址就可以找到对应的物理地址，虚拟地址一般比物理都要大。

这是一张地址映射的模型图：
![VA-PA][2]
 
 
 
**三，与MMU相关的几个内存概念**

**1.地址类型**

在MMU中可以简单理解为，**CPU发给MMU的是虚拟地址[0, 4G]，经过MMU转换后生成物理地址**。但是CPU不关心发送的地址类型，如果没有启动MMU，那么CPU发送的就是实际的物理地址了。
 
 **2.页**
 
 页是内存常见的概念：**页是内存存储的最小单元**，是一片**内存区域**，一般是**4K**，也有8K和16K。
 
**3.段**

多个页组成一个段。

**4.存储空间**

多个段组成存储空间。
 
**5.缺页**

内存缺页类似缓存不命中，即在页中没有找到有用的数据。在Linux运行中，如果不发生缺页，就直接读取内存，如果发生缺页，OS就引发**缺页异常**，此时OS一般都会从其他地方取数据。

**6.页保护**

简单来说就是**保护页不被许多进程并发访问**，提高数据的安全性。

**7.内存分段**

虚拟内存可以分为：代码段，数据段，堆栈段，bss段等。物理内存可以分段。



**四，MMU地址转换**

地址转换就是将进程虚拟地址转换成物理地址。MMU利用一个映射表格：**页表(Page Table)**，来进行地址转换。

**什么是页表？**

就是存储虚拟地址到物理地址映射关系的表格，格式像下面这样：

``` 
虚拟地址		物理地址		是否却页的标记(1表示不缺页，0表示缺页 )
0x10		0xF5		1
```
这个映射关系表明：虚拟地址0x10映射到物理地址0xF5,并且虚拟地址不缺页。


**页表存储在哪里？**

CPU中有个**页表寄存器**来存储**页表的首地址**


另外MMU还利用TLB快表，来加快地址转换。**(Translation Lookaside Buffers, TLB)**，可以看作是页表的一个**缓存**，它也是一张**表**，相当于**将页表进行分区**，TLB记录每个区的信息，MMU在转换过程中，**先查找TLB**确定要转换的虚拟地址在TLB中的**分区**，再在实际的页表中查找对应的区中的物理地址，这样就加快了查询的速度。TLB实际上就是一个HashTable。

过程如下：
**CPU发送的虚拟地址 -> MMU(TLB -> PageTable) -> 物理地址**

注意：TLB也会出现缺页，系统处理TLB的缺页有2中情况：

1.当缺少的页在主存中时，只需要创建该页的TLB表项即可。

2.当缺少的页不在主存中时，需要将控制权交给OS来解决缺页，实际上就是产生缺页中断。





  [1]: https://cheng-zhi.github.io/img/post-2017-02-23-MMU.png
  [2]: https://cheng-zhi.github.io/img/post-2017-02-23-VA-PA.png
